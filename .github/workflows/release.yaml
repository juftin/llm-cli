name: Release

on:
    push:
        branches:
            - main

jobs:
    release:
        name: github-release
        if: github.repository_owner == 'juftin'
        runs-on: ubuntu-latest
        permissions:
            contents: write
            issues: write
            pull-requests: write
        steps:
            - name: Check out the repository
              uses: actions/checkout@v4
              with:
                  fetch-depth: 2
            - name: Semantic Release
              uses: juftin/actions/semantic-release@v1
              with:
                  github_token: ${{ secrets.PERSONAL_ACCESS_TOKEN }}

    github-pages-publish:
        runs-on: ubuntu-latest
        needs: release
        if: github.ref == 'refs/heads/main' && github.repository_owner == 'juftin'
        permissions:
            pages: write
            id-token: write
        environment:
            name: github-pages
            url: ${{ steps.deployment.outputs.page_url }}
        steps:
            - name: Checkout Latest Changes
              uses: actions/checkout@v4
              with:
                  ref: ${{ github.ref }}
                  fetch-depth: 0
            - name: Install uv
              uses: astral-sh/setup-uv@v5
              with:
                  version: latest
                  python-version: 3.11
            - name: Install Python Dependencies
              run: task install
            - name: Build Site
              run: task docs -- build
            - name: Setup GitHub Pages
              uses: actions/configure-pages@v4
            - name: Upload Artifact
              uses: actions/upload-pages-artifact@v3
              with:
                  path: site/
            - name: Deploy to GitHub Pages
              id: deployment
              uses: actions/deploy-pages@v4
